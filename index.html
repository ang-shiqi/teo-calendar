<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shared Cloud Calendar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Itim&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Global font */
    body { font-family: 'Itim', 'Quicksand', ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; }

    /* --- Kawaii Scrapbook aesthetic --- */
    :root{
      --paper: #fffdf7;
      --paper-border: rgba(15, 23, 42, 0.10);
      --shadow: 0 18px 45px rgba(15, 23, 42, 0.20);
      --shadow-soft: 0 10px 22px rgba(15, 23, 42, 0.12);
    }

    body.scrapbook {
      /* High-quality corkboard image.
         Recommended: add /assets/corkboard.jpg to the repo and use that path.
         For now, this uses a texture URL fallback.
      */
      background-color: #b7845a;
      background-image:
        url('/assets/corkboard.jpg'),
        url('https://www.transparenttextures.com/patterns/cork-board.png');
      background-size: cover, auto;
      background-position: center, top left;
      background-attachment: fixed, fixed;
    }

    .scrapbook-paper {
      position: relative;
      overflow: visible;
      background: var(--paper);
      border: 1px solid rgba(15, 23, 42, 0.10);
      box-shadow: 0 22px 55px rgba(15, 23, 42, 0.22);
      transform: rotate(-1.0deg);

      /* uneven paper edges */
      clip-path: polygon(
        1% 2%, 6% 1%, 14% 2%, 22% 1%, 31% 2%, 40% 1%, 49% 2%, 58% 1%, 68% 2%, 77% 1%, 86% 2%, 94% 1%, 99% 2%,
        99% 10%, 98% 18%, 99% 27%, 98% 35%, 99% 44%, 98% 53%, 99% 62%, 98% 71%, 99% 80%, 98% 89%, 99% 98%,
        92% 99%, 84% 98%, 76% 99%, 68% 98%, 60% 99%, 52% 98%, 44% 99%, 36% 98%, 28% 99%, 20% 98%, 12% 99%, 4% 98%,
        1% 96%, 2% 88%, 1% 79%, 2% 71%, 1% 62%, 2% 54%, 1% 45%, 2% 37%, 1% 28%, 2% 20%, 1% 12%
      );
    }

    .scrapbook-paper > .paper-inner {
      transform: rotate(1.0deg);
      padding-top: 60px; /* header safe zone */
    }

    /* subtle inner border + paper grain */
    .scrapbook-paper::before {
      content: "";
      position: absolute;
      inset: 12px;
      pointer-events: none;
      border: 1px solid rgba(15, 23, 42, 0.05);
      opacity: 0.9;
    }

    .scrapbook-paper::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background-image: url('https://www.transparenttextures.com/patterns/paper-2.png');
      opacity: 0.28;
      mix-blend-mode: multiply;
    }

    /* cute tape */
    /* Cute pins (3D-ish) */
    .scrapbook-pin {
      position: absolute;
      top: -12px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
      z-index: 3;
    }
    .scrapbook-pin::after {
      content: "";
      position: absolute;
      inset: 3px 4px auto 4px;
      height: 7px;
      border-radius: 999px;
      background: rgba(255,255,255,0.65);
      transform: rotate(-12deg);
    }
    .scrapbook-pin.tl { left: 18px; top: -12px; background: radial-gradient(circle at 30% 30%, #fff, #ff5fa2 40%, #cc2a6f 85%); }
    .scrapbook-pin.tr { right: 18px; top: -12px; background: radial-gradient(circle at 30% 30%, #fff, #7cdbff 40%, #1f8db8 85%); }
    .scrapbook-pin.bl { left: 18px; bottom: -12px; top: auto; background: radial-gradient(circle at 30% 30%, #fff, #b5ff7c 40%, #4ea31d 85%); }
    .scrapbook-pin.br { right: 18px; bottom: -12px; top: auto; background: radial-gradient(circle at 30% 30%, #fff, #ffd36e 40%, #d08a00 85%); }

    /* Curved ribbon banner for month header */
    .washi-banner {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transform: translateY(18px); /* sit lower on the paper */
    }
    .washi-banner svg { display: block; }

    /* Decorative clouds + sun */

    /* Wooden frame around the paper */
    .wood-frame {
      padding: 28px;
      padding-top: 44px; /* breathing room so header/ribbons don't get cropped */
      border-radius: 26px;
      background: linear-gradient(180deg, #c58a52, #a86b3c);
      box-shadow: 0 22px 55px rgba(15,23,42,0.25);
      position: relative;
      overflow: visible;
    }
    .wood-frame::before {
      content: "";
      position: absolute;
      inset: 6px;
      border-radius: 22px;
      background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0));
      pointer-events: none;
      opacity: 0.45;
    }

    /* Term ribbon pinned to top-right of paper */
    .term-ribbon {
      position: absolute;
      top: 54px;
      right: -6px;
      padding: 10px 16px;
      background: #ff86b8;
      color: #7a1f44;
      font-weight: 800;
      letter-spacing: 0.5px;
      border-radius: 12px;
      transform: rotate(10deg);
      box-shadow: 0 14px 22px rgba(15,23,42,0.18);
      border: 1px solid rgba(219,39,119,0.22);
      z-index: 6;
      clip-path: polygon(0% 15%, 92% 0%, 100% 50%, 92% 100%, 0% 85%, 6% 50%);
    }
    .term-ribbon::after { content: none; }

    /* Stickers */
    .sticker {
      position: absolute;
      right: 14px;
      bottom: 14px;
      padding: 8px 10px;
      background: rgba(255,255,255,0.95);
      border-radius: 18px;
      box-shadow: 0 12px 18px rgba(15,23,42,0.16);
      border: 2px solid rgba(15,23,42,0.06);
      z-index: 3;
      transform: rotate(-6deg);
      font-weight: 700;
      color: #7a1f44;
    }
    .sticker-exam {
      background: #fff6bf;
      border-color: rgba(122,31,68,0.18);
      transform: rotate(8deg);
      padding: 14px 16px;
      border-radius: 20px;
      font-size: 16px;
    }
    .sticker-wa1 {
      background: #d6ecff;
      border-color: rgba(31,141,184,0.20);
    }

    .cell-illustration {
      width: 100%;
      height: 78px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 6px;
      opacity: 0.98;
    }

    .kawaii-cloud {
      position: absolute;
      top: -18px;
      width: 120px;
      height: 52px;
      background: rgba(255,255,255,0.92);
      border-radius: 999px;
      box-shadow: 0 10px 18px rgba(15,23,42,0.10);
      z-index: 1;
    }
    .kawaii-cloud::before,
    .kawaii-cloud::after {
      content: "";
      position: absolute;
      background: rgba(255,255,255,0.92);
      border-radius: 999px;
    }
    .kawaii-cloud::before { width: 54px; height: 54px; left: 14px; top: -18px; }
    .kawaii-cloud::after { width: 64px; height: 64px; right: 12px; top: -26px; }

    .kawaii-sun {
      position: absolute;
      top: -18px;
      right: 26px;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fffbe6, #ffd36e 45%, #ffb703 88%);
      box-shadow: 0 12px 18px rgba(15,23,42,0.12);
      z-index: 1;
    }
    .kawaii-sun::before {
      content: "";
      position: absolute;
      inset: -10px;
      background: conic-gradient(from 0deg, rgba(255, 183, 3, 0.0), rgba(255, 183, 3, 0.35), rgba(255, 183, 3, 0.0));
      border-radius: 999px;
      filter: blur(0.2px);
      opacity: 0.35;
    }
    .kawaii-sun-face {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: rgba(124, 45, 18, 0.80);
      font-size: 14px;
      z-index: 2;
    }
  </style>
</head>

<body class="scrapbook text-slate-800 font-sans antialiased min-h-screen flex flex-col items-center py-10 px-4 sm:px-6">
  <!-- Top-of-screen environment decorations -->
  <div class="pointer-events-none fixed left-6 top-3 z-0 kawaii-cloud" style="transform: scale(0.95); opacity: 0.95" aria-hidden="true"></div>
  <div class="pointer-events-none fixed left-44 top-1 z-0 kawaii-cloud" style="transform: scale(1.25); opacity: 0.95" aria-hidden="true"></div>
  <div class="pointer-events-none fixed left-[60%] top-2 z-0 kawaii-cloud" style="transform: scale(1.05); opacity: 0.92" aria-hidden="true"></div>
  <div class="pointer-events-none fixed right-10 top-4 z-0 kawaii-cloud" style="transform: scale(0.85); opacity: 0.92" aria-hidden="true"></div>
  <div class="pointer-events-none fixed right-6 top-6 z-0 kawaii-sun" aria-hidden="true"></div>

  <div class="w-full max-w-5xl wood-frame">
    <div class="scrapbook-paper">
      <!-- 4-corner push pins -->
      <div class="scrapbook-pin tl" aria-hidden="true"></div>
      <div class="scrapbook-pin tr" aria-hidden="true"></div>
      <div class="scrapbook-pin bl" aria-hidden="true"></div>
      <div class="scrapbook-pin br" aria-hidden="true"></div>

      <!-- Term ribbon removed -->

      <div class="paper-inner overflow-visible">
    <!-- Header -->
    <div class="relative flex flex-col md:flex-row md:items-center justify-between px-6 py-6 border-b border-slate-200 bg-white gap-4">
      <!-- Decorative clouds + sun -->
      <div class="kawaii-cloud" style="left: 22px" aria-hidden="true"></div>
      <div class="kawaii-cloud" style="left: 170px; transform: scale(0.8); opacity: 0.95; top: -10px" aria-hidden="true"></div>
      <div class="kawaii-sun" aria-hidden="true"><div class="kawaii-sun-face">^â€¿^</div></div>
      <div>
        <h2 id="current-month-year" class="text-2xl font-bold text-slate-800">
          <span class="washi-banner" aria-hidden="true">
            <svg viewBox="0 0 420 90" class="w-[320px] sm:w-[360px] h-[60px]" role="img" aria-label="Month">
              <path d="M20 30 C90 5, 160 5, 210 20 C260 5, 330 5, 400 30 L380 80 C310 62, 250 62, 210 70 C170 62, 110 62, 40 80 Z" fill="#ff86b8" stroke="rgba(219,39,119,0.28)" stroke-width="3" />
              <path d="M35 35 C100 15, 160 15, 210 25 C260 15, 320 15, 385 35" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="6" stroke-linecap="round" />
              <text id="month-ribbon-text" x="210" y="56" text-anchor="middle" fill="#7a1f44" font-size="26" font-weight="700">Month Year</text>
            </svg>
          </span>
        </h2>
        <div id="sync-status" class="text-xs text-amber-500 font-medium flex items-center gap-2">
          <i data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i>
          <span>Connectingâ€¦</span>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2 w-full sm:w-auto sm:flex sm:flex-wrap sm:items-center sm:gap-4 sm:justify-end">
        <select id="calendar-select" class="w-full sm:w-auto px-3 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-lg border border-slate-200 hover:bg-slate-200">
          <option value="ALL">All</option>
          <option value="shiqi">Shi Qi</option>
          <option value="jovan">Jovan</option>
          <option value="asher">Asher</option>
          <option value="winson">Winson</option>
        </select>
        <button id="unlock-btn" class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors">
          Unlock editing
        </button>

        <div class="w-full sm:w-auto flex items-center gap-1 bg-slate-50 border border-slate-200 rounded-lg p-1" role="group" aria-label="Calendar view">
          <button id="view-month" class="px-3 py-1.5 text-sm font-medium rounded-md bg-white text-slate-700 shadow-sm">Month</button>
          <button id="view-week" class="px-3 py-1.5 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-100">Week</button>
        </div>

        <button id="today-btn" class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors">
          Today
        </button>
        <button id="jump-btn" class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors">
          Jumpâ€¦
        </button>
        <input id="jump-month" type="month" class="hidden sm:w-auto px-3 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-lg border border-slate-200" />

        <div class="w-full sm:w-auto flex items-center gap-1 bg-slate-50 border border-slate-200 rounded-lg p-1 justify-between">
          <button id="prev" class="p-1.5 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-md transition-colors">
            <i data-lucide="chevron-left" class="w-5 h-5"></i>
          </button>
          <button id="next" class="p-1.5 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-md transition-colors">
            <i data-lucide="chevron-right" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Days of Week -->
    <div class="grid grid-cols-7 bg-slate-50 border-b border-slate-200">
      <div class="py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Sun</div>
      <div class="py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Mon</div>
      <div class="py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Tue</div>
      <div class="py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Wed</div>
      <div class="py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Thu</div>
      <div class="py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Fri</div>
      <div class="py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Sat</div>
    </div>

    <!-- Calendar Grid -->
    <div id="calendar-grid" class="grid grid-cols-7 auto-rows-[150px] sm:auto-rows-[220px] bg-slate-200 gap-px">
      <!-- injected -->
    </div>
      </div>
    </div>
  </div>

  <!-- Edit Event Modal -->
  <div id="event-modal" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md sm:max-w-md overflow-hidden transform transition-all">
      <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-slate-800" id="modal-title">Add/Edit</h3>
        <button id="close-modal" class="text-slate-400 hover:text-slate-600 transition-colors">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-6">
        <input type="hidden" id="event-date-key" />
        <div class="mb-4">
          <label class="block text-sm font-medium text-slate-700 mb-2">Items for this day</label>
          <div id="event-items" class="space-y-2"></div>
          <button id="add-item-row" type="button" class="mt-3 px-3 py-1.5 text-sm font-medium text-indigo-700 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors">
            Add row
          </button>
        </div>
        <div class="flex justify-end gap-3 mt-6">
          <button id="delete-event" class="px-4 py-2 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
            Clear
          </button>
          <button id="save-event" class="px-6 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-sm transition-colors">
            Save to Cloud
          </button>
        </div>
        <p id="edit-hint" class="mt-3 text-xs text-slate-500"></p>
      </div>
    </div>
  </div>

  <!-- Load firebase config from config.js so you only fill it once -->
  <script src="./config.js"></script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, where, documentId } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    const firebaseConfig = window.FIREBASE_CONFIG;
    if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes('PASTE')) {
      console.error('Missing FIREBASE_CONFIG. Fill config.js');
    }

    // 2) This is the Firestore path namespace for your calendar
    // Each person gets their own calendar namespace (separate data in Firestore).
    // You can rename these ids, but keep them consistent once you start using them.
    const USERS = [
      { id: 'shiqi', label: 'Shi Qi' },
      { id: 'jovan', label: 'Jovan' },
      { id: 'asher', label: 'Asher' },
      { id: 'winson', label: 'Winson' }
    ];

    // Firestore namespace for this app (shared across users)
    const APP_ID = 'teo-calendar-v2';

    // Filter: 'ALL' or one of USERS ids
    let currentUserFilter = 'ALL';

    // Persist per device/browser
    const UI_STATE_KEY = `teo-calendar:${APP_ID}:uiState`;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // State
    let user = null;
    let currentDate = new Date();
    let events = {}; // { 'YYYY-MM-DD': { items: Array<{ text: string, users: string[] }>, text: string, users: string[] } }
    let unsubscribeSync = null;
    let syncDebounceTimer = null;
    let lastRangeKey = null;
    let canEdit = false;
    let viewMode = "month"; // "month" | "week"
    let editingItems = [];

    function loadUiState() {
      try {
        const raw = localStorage.getItem(UI_STATE_KEY);
        if (!raw) return;
        const s = JSON.parse(raw);

        // user filter
        if (typeof s?.user === 'string') currentUserFilter = s.user;

        // view mode
        if (s?.view === 'month' || s?.view === 'week') viewMode = s.view;

        // date
        if (typeof s?.date === 'string') {
          const d = new Date(s.date);
          if (!Number.isNaN(d.getTime())) currentDate = d;
        }
      } catch (_) {}
    }

    function saveUiState() {
      try {
        localStorage.setItem(UI_STATE_KEY, JSON.stringify({
          user: currentUserFilter,
          view: viewMode,
          date: currentDate.toISOString(),
        }));
      } catch (_) {}
    }

    // Load persisted UI state (per device/browser)
    loadUiState();

    // Mobile: if no saved state set view to Week (less cramped than Month)
    if (!localStorage.getItem(UI_STATE_KEY) && window.matchMedia && window.matchMedia('(max-width: 640px)').matches) {
      viewMode = 'week';
    }

    // DOM
    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonthYear = document.getElementById('current-month-year');
    const syncStatus = document.getElementById('sync-status');
    const eventModal = document.getElementById('event-modal');
    const eventItems = document.getElementById('event-items');
    const addItemRowBtn = document.getElementById('add-item-row');
    const eventDateKey = document.getElementById('event-date-key');
    const editHint = document.getElementById('edit-hint');

    const calendarSelect = document.getElementById('calendar-select');

    const viewMonthBtn = document.getElementById('view-month');
    const viewWeekBtn = document.getElementById('view-week');

    const unlockBtn = document.getElementById('unlock-btn');
    const saveBtn = document.getElementById('save-event');
    const clearBtn = document.getElementById('delete-event');
    const jumpBtn = document.getElementById('jump-btn');
    const jumpMonth = document.getElementById('jump-month');
    const USER_IDS = new Set(USERS.map((u) => u.id));

    function normalizeUsers(users, fallbackUsers = []) {
      const src = (Array.isArray(users) && users.length > 0) ? users : fallbackUsers;
      const out = [];
      src.forEach((id) => {
        if (USER_IDS.has(id) && !out.includes(id)) out.push(id);
      });
      return out;
    }

    function normalizeItems(rawItems, fallbackUsers = []) {
      if (!Array.isArray(rawItems)) return [];
      return rawItems
        .map((item) => {
          if (!item || typeof item !== 'object') return null;
          const text = typeof item.text === 'string' ? item.text.trim() : '';
          if (!text) return null;
          return { text, users: normalizeUsers(item.users, fallbackUsers) };
        })
        .filter(Boolean);
    }

    function getDefaultUsersForNewItem() {
      if (USER_IDS.has(currentUserFilter)) return [currentUserFilter];
      return ['shiqi'];
    }

    function eventFromFirestoreDoc(data) {
      const docUsers = normalizeUsers(data.users);
      let items;
      if (Array.isArray(data.items)) {
        items = normalizeItems(data.items, docUsers);
      } else {
        const legacyText = typeof data.text === 'string' ? data.text : '';
        items = legacyText
          .split(/\n+/)
          .map((line) => line.trim())
          .filter(Boolean)
          .map((text) => ({ text, users: [...docUsers] }));
      }

      const text = items.map((item) => item.text).join('\n');
      const users = [...new Set(items.flatMap((item) => item.users))];
      return { items, text, users, lastUpdated: data.lastUpdated || '', updatedBy: data.updatedBy || '' };
    }

    function setStatus(kind, text) {
      if (kind === 'loading') {
        syncStatus.className = 'text-xs text-amber-500 font-medium flex items-center gap-2';
        syncStatus.innerHTML = '<i data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i><span>' + text + '</span>';
      } else if (kind === 'ok') {
        syncStatus.className = 'text-xs text-emerald-600 font-medium flex items-center gap-2';
        syncStatus.innerHTML = '<i data-lucide="check-circle" class="w-3 h-3"></i><span>' + text + '</span>';
      } else {
        syncStatus.className = 'text-xs text-red-600 font-medium flex items-center gap-2';
        syncStatus.innerHTML = '<i data-lucide="alert-circle" class="w-3 h-3"></i><span>' + text + '</span>';
      }
      lucide.createIcons();
    }

    function updateEditUi() {
      unlockBtn.textContent = canEdit ? 'Editing unlocked' : 'Unlock editing';
      unlockBtn.disabled = canEdit;
      unlockBtn.classList.toggle('opacity-50', canEdit);

      // save/clear are only meaningful when unlocked
      saveBtn.disabled = !canEdit;
      clearBtn.disabled = !canEdit;
      addItemRowBtn.disabled = !canEdit;
      saveBtn.classList.toggle('opacity-50', !canEdit);
      clearBtn.classList.toggle('opacity-50', !canEdit);
      addItemRowBtn.classList.toggle('opacity-50', !canEdit);

      editHint.textContent = canEdit ? 'Editing is unlocked on this browser.' : 'Read-only. Tap â€œUnlock editingâ€ and enter passcode to edit.';
      renderItemRows();
    }

    async function initAuth() {
      setStatus('loading', 'Signing inâ€¦');
      try {
        // Read-only users still need a Firebase auth session to read (depending on your rules).
        await signInAnonymously(auth);
      } catch (err) {
        console.error(err);
        setStatus('error', 'Auth failed');
      }
    }

    onAuthStateChanged(auth, (u) => {
      user = u;
      if (user) setupRealtimeSync();
    });

    function eventsCollection() {
      return collection(db, 'artifacts', APP_ID, 'public', 'data', 'events');
    }

    function rangeForCurrentView() {
      // Returns { startKey, endKey, rangeKey, cacheMonthKey? }
      if (viewMode === 'week') {
        const start = startOfWeek(currentDate);
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        const startKey = formatDateKey(start);
        const endKey = formatDateKey(end);
        return { startKey, endKey, rangeKey: `week:${startKey}..${endKey}` };
      }

      // Month view
      const y = currentDate.getFullYear();
      const m = currentDate.getMonth();
      const monthStart = new Date(y, m, 1);
      const monthEnd = new Date(y, m + 1, 0);
      const startKey = formatDateKey(monthStart);
      const endKey = formatDateKey(monthEnd);
      const monthKey = `${y}-${String(m + 1).padStart(2, '0')}`;
      return { startKey, endKey, rangeKey: `month:${monthKey}`, cacheMonthKey: monthKey };
    }

    function cacheKeyForMonth(monthKey) {
      return `teo-calendar:${APP_ID}:events:${monthKey}`;
    }

    function loadMonthCache(monthKey) {
      try {
        const raw = localStorage.getItem(cacheKeyForMonth(monthKey));
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        const ts = Number(parsed?.ts);
        const data = parsed?.data;
        if (!ts || !data || typeof data !== 'object') return null;

        // TTL: 7 days
        const ageMs = Date.now() - ts;
        if (ageMs > 7 * 24 * 60 * 60 * 1000) return null;
        return data;
      } catch (_) {
        return null;
      }
    }

    function saveMonthCache(monthKey, data) {
      try {
        localStorage.setItem(cacheKeyForMonth(monthKey), JSON.stringify({ ts: Date.now(), data }));
      } catch (_) {}
    }

    function setupRealtimeSync() {
      const { startKey, endKey, rangeKey, cacheMonthKey } = rangeForCurrentView();

      if (rangeKey !== lastRangeKey) {
        setStatus('loading', 'Syncingâ€¦');
      }

      // Month cache: render immediately from cache (if any)
      if (cacheMonthKey) {
        const cached = loadMonthCache(cacheMonthKey);
        if (cached && rangeKey !== lastRangeKey) {
          events = cached;
          renderCalendar();
        }
      }

      // Switch listener when range changes
      if (typeof unsubscribeSync === 'function') {
        try { unsubscribeSync(); } catch (_) {}
      }

      lastRangeKey = rangeKey;

      const q = query(
        eventsCollection(),
        where(documentId(), '>=', startKey),
        where(documentId(), '<=', endKey)
      );

      unsubscribeSync = onSnapshot(
        q,
        (snapshot) => {
          const next = {};
          snapshot.forEach((d) => {
            const data = d.data() || {};
            next[d.id] = eventFromFirestoreDoc(data);
          });
          events = next;
          if (cacheMonthKey) saveMonthCache(cacheMonthKey, next);
          renderCalendar();
          setStatus('ok', canEdit ? 'Cloud synced (editable)' : 'Cloud synced (read-only)');
        },
        (error) => {
          console.error(error);
          setStatus('error', 'Sync error (check Firestore rules)');
        }
      );
    }

    function scheduleSync() {
      if (syncDebounceTimer) clearTimeout(syncDebounceTimer);
      syncDebounceTimer = setTimeout(() => {
        if (user) setupRealtimeSync();
      }, 250);
    }

    async function unlockEditing() {
      const passcode = window.prompt('Enter edit passcode');
      if (!passcode) return;

      setStatus('loading', 'Unlockingâ€¦');
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ passcode })
        });
        if (!res.ok) throw new Error('Bad passcode');
        const data = await res.json();
        if (!data?.token) throw new Error('No token');

        await signInWithCustomToken(auth, data.token);
        canEdit = true;
        updateEditUi();
        setStatus('ok', 'Cloud synced (editable)');
      } catch (e) {
        console.error(e);
        canEdit = false;
        updateEditUi();
        setStatus('error', 'Wrong passcode');
      }
    }

    async function saveEvent() {
      if (!canEdit) return;
      const date = eventDateKey.value;
      if (!user || !date) return;

      const ref = doc(db, 'artifacts', APP_ID, 'public', 'data', 'events', date);
      const items = normalizeItems(editingItems);
      if (items.length > 0) {
        const text = items.map((item) => item.text).join('\n');
        const users = [...new Set(items.flatMap((item) => item.users))];
        await setDoc(ref, {
          items,
          text,
          users,
          lastUpdated: new Date().toISOString(),
          updatedBy: user.uid
        }, { merge: true });
      } else {
        await deleteDoc(ref);
      }
      closeModal();
    }

    async function deleteDayEvent() {
      if (!canEdit) return;
      const date = eventDateKey.value;
      if (!user || !date) return;
      await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'events', date));
      closeModal();
    }

    function renderCalendar() {
      calendarGrid.innerHTML = '';

      // Week view: make cells taller and avoid per-cell scrolling (show +more instead)
      if (viewMode === 'week') {
        calendarGrid.classList.remove('auto-rows-[150px]', 'sm:auto-rows-[220px]');
        calendarGrid.classList.add('auto-rows-[500px]', 'sm:auto-rows-[400px]');
      } else {
        calendarGrid.classList.remove('auto-rows-[500px]', 'sm:auto-rows-[400px]');
        calendarGrid.classList.add('auto-rows-[150px]', 'sm:auto-rows-[220px]');
      }

      if (viewMode === 'month') {
        renderMonth();
      } else {
        renderWeek();
      }

      lucide.createIcons();

      // Sync only the visible range (debounced) to reduce Firestore reads.
      scheduleSync();
    }

    function startOfWeek(date) {
      // Week starts on Sunday.
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() - d.getDay());
      return d;
    }

    function sameDay(a, b) {
      return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
    }

    function formatDateKey(d) {
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    function jumpTo() {
      // Lazy / no-typing version: use native month picker when available.
      // Fallback: prompt.
      if (jumpMonth) {
        // Prefill with current visible month
        const y = currentDate.getFullYear();
        const m = String(currentDate.getMonth() + 1).padStart(2, '0');
        jumpMonth.value = `${y}-${m}`;

        // Try to open the native picker (Chrome/Edge). If unsupported, just show the input.
        try {
          jumpMonth.classList.remove('hidden');
          // @ts-ignore
          if (typeof jumpMonth.showPicker === 'function') jumpMonth.showPicker();
          else jumpMonth.focus();
        } catch (_) {
          jumpMonth.classList.remove('hidden');
          jumpMonth.focus();
        }
        return;
      }

      // Fallback: Accept YYYY-MM or YYYY-MM-DD
      const raw = window.prompt('Jump to (YYYY-MM or YYYY-MM-DD), e.g. 2026-07 or 2026-07-15');
      if (!raw) return;
      const s = raw.trim();
      const m1 = s.match(/^(\d{4})-(\d{2})$/);
      const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      let d;
      if (m2) d = new Date(Number(m2[1]), Number(m2[2]) - 1, Number(m2[3]));
      else if (m1) d = new Date(Number(m1[1]), Number(m1[2]) - 1, 1);
      else return window.alert('Invalid format. Use YYYY-MM or YYYY-MM-DD');

      if (Number.isNaN(d.getTime())) return window.alert('Invalid date');
      currentDate = d;
      renderCalendar();
    }

    function setMonthTitle(text) {
      const t = document.getElementById('month-ribbon-text');
      if (t) t.textContent = text;
      else currentMonthYear.textContent = text;
    }

    function renderMonth() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      setMonthTitle(new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentDate));

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const daysInPrevMonth = new Date(year, month, 0).getDate();
      const today = new Date();

      const formatDate = (y, m, d) => `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

      for (let i = 0; i < firstDay; i++) createDayCell(daysInPrevMonth - firstDay + i + 1, true);
      for (let d = 1; d <= daysInMonth; d++) {
        const dateKey = formatDate(year, month, d);
        const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === d;
        createDayCell(d, false, dateKey, isToday);
      }
      const totalUsed = firstDay + daysInMonth;
      for (let i = 1; i <= 42 - totalUsed; i++) createDayCell(i, true);
    }

    function renderWeek() {
      const start = startOfWeek(currentDate);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);

      const fmt = new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric' });
      const title = `${fmt.format(start)} â€“ ${fmt.format(end)}, ${end.getFullYear()}`;
      setMonthTitle(title);

      const today = new Date();
      for (let i = 0; i < 7; i++) {
        const d = new Date(start);
        d.setDate(start.getDate() + i);
        const dateKey = formatDateKey(d);
        const isToday = sameDay(d, today);
        createDayCell(d.getDate(), false, dateKey, isToday);
      }
    }

    function createDayCell(day, isFaded, dateKey, isToday) {
      const cell = document.createElement('div');
      const overflowClass = (viewMode === 'week') ? 'overflow-auto no-scrollbar' : 'overflow-auto no-scrollbar';
      cell.className = `bg-white p-1 sm:p-2 flex flex-col group relative border-none ${overflowClass} ${isFaded ? 'text-slate-300' : 'text-slate-700 cursor-pointer hover:bg-indigo-50/50'}`;

      const num = document.createElement('span');

      if (isToday) {
        // Today marker: SVG heart (reliable across browsers)
        num.className = 'relative w-10 h-10 mb-1 flex items-center justify-center z-10';
        num.innerHTML = `
          <svg viewBox="0 0 24 24" class="absolute inset-0 w-full h-full" aria-hidden="true">
            <path fill="#ec4899" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
          <span class="relative z-10 text-base font-extrabold text-white leading-none -mt-1">${day}</span>
        `;
      } else {
        num.className = 'text-sm font-semibold w-7 h-7 flex items-center justify-center rounded-full mb-1';
        num.textContent = day;
      }

      cell.appendChild(num);

      if (dateKey && events[dateKey]) {
        const ev = events[dateKey];
        const allItems = Array.isArray(ev.items) ? ev.items : [];
        const filteredItems = allItems.filter((item) => {
          if (currentUserFilter === 'ALL') return true;
          return Array.isArray(item.users) && item.users.includes(currentUserFilter);
        });

        function extractStartMinutes(text) {
          const s = String(text || '');

          // Find earliest time occurrence (by index) among supported formats.
          let best = null; // { idx: number, mins: number }

          // 24h: 18:30
          const r24 = /\b([01]\d|2[0-3]):([0-5]\d)\b/g;
          for (const m of s.matchAll(r24)) {
            const mins = Number(m[1]) * 60 + Number(m[2]);
            const idx = m.index ?? 1e9;
            if (!best || idx < best.idx) best = { idx, mins };
          }

          // 12h: 6.30pm / 6:30pm / 6.30 pm
          const r12 = /\b(\d{1,2})[\.:]([0-5]\d)\s*(am|pm)\b/gi;
          for (const m of s.matchAll(r12)) {
            let h = Number(m[1]);
            const minsPart = Number(m[2]);
            const ap = String(m[3]).toLowerCase();
            if (h === 12) h = 0;
            let h24 = h + (ap === 'pm' ? 12 : 0);
            const mins = h24 * 60 + minsPart;
            const idx = m.index ?? 1e9;
            if (!best || idx < best.idx) best = { idx, mins };
          }

          return best ? best.mins : null;
        }

        // Sort by time (display-only). Items without time should be at the top.
        const sortedItems = [...filteredItems].sort((a, b) => {
          const ta = extractStartMinutes(a?.text);
          const tb = extractStartMinutes(b?.text);
          if (ta == null && tb == null) return 0;
          if (ta == null) return -1;
          if (tb == null) return 1;
          return ta - tb;
        });

        if (sortedItems.length > 0) {
          // Stickers (scrapbook overlays)
          function firstMatch(pred) {
            return sortedItems.find((it) => pred((it?.text || '').toLowerCase()));
          }

          // Stickers: SUPER EXAM
          const hasExam = !!firstMatch((s) => s.includes('exam') || s.includes('psle') || s.includes('wa'));
          if (hasExam) {
            const st = document.createElement('div');
            st.className = 'sticker sticker-exam';
            st.textContent = 'SUPER EXAM!';
            cell.appendChild(st);
          }

          // Render separate chips so different items can keep their own colors
          const chipBase = 'text-[10px] font-bold leading-tight px-2.5 py-1.5 rounded-full border border-transparent shadow-sm';

          function formatTimes12h(line) {
            // Display-only: convert 24h times like 18:30 -> 6.30pm
            return (line || '').replace(/\b([01]\d|2[0-3]):([0-5]\d)\b/g, (_, hh, mm) => {
              const h24 = Number(hh);
              const m = String(mm);
              const suffix = h24 >= 12 ? 'pm' : 'am';
              let h12 = h24 % 12;
              if (h12 === 0) h12 = 12;
              return `${h12}.${m}${suffix}`;
            });
          }

          function emojiForLine(line) {
            const s = (line || '').toLowerCase();
            if (s.includes('climbing') || s.includes('bouldering') || s.includes('top rope') || s.includes('lead')) return 'ðŸ§—';
            if (s.includes('revision time')) return 'ðŸ“–';
            if (s.includes('science')) return 'ðŸ§ª';
            if (s.includes('exam') || s.includes('psle') || s.includes('wa')) return 'ðŸ“';
            if (s.includes('spelling')) return 'ðŸ”¤';
            if (s.includes('swimming')) return 'ðŸŠ';
            if (s.includes('skating')) return 'â›¸ï¸';
            if (s.includes('tuition')) return 'ðŸ“š';
            if (s.includes('competition')) return 'ðŸ†';
            if (s.includes('birthday')) return 'ðŸŽ‚';
            if (s.includes('public holiday')) return 'ðŸŽ‰';
            if (s.includes('school vacation') || s.includes('school holiday') || s.includes('school day off')) return 'ðŸ«';
            if (s.includes('cca')) return 'ðŸŽ½';
            return '';
          }

          function chipClassForLine(line) {
            const s = (line || '').toLowerCase();
            const isPublicHoliday = s.includes('public holiday');
            const isCompetition = s.includes('competition');
            const isSpelling = s.includes('spelling');
            const isSkating = s.includes('skating');
            const isSwimming = s.includes('swimming');
            const isLeadClass = s.includes('lead class');
            const isChineseTuition = s.includes('chinese tuition');
            const isEnglishTuition = s.includes('english tuition');
            const isRevisionTime = s.includes('revision time');
            const isCCA = s.includes('cca');
            const isExam = s.includes('psle') || s.includes('weighted assessment') || /\bwa\d*\b/i.test(line) || s.includes('eoy') || s.includes('exam');
            const isBirthday = s.includes('birthday');
            const isSchool = s.includes('school holiday') || s.includes('school vacation') || s.includes('school day off');
            const isNoClimbing = s === 'no climbing class' || s.includes('no climbing class');
            // Any climbing-related training/notes should be light green
            const isClimbing = !isNoClimbing && (
              s.includes('climbing')
              || s.includes('bouldering')
              || s.includes('lead')
              || s.includes('top rope')
              || s.includes('speed training')
              || s.includes('campus')
            );

            if (isPublicHoliday) return 'bg-red-50 text-red-700 border-red-400';
            if (isCompetition) return 'bg-[#800020] text-white border-[#3D0010]';
            if (isSwimming) return 'bg-[#d6ecff] text-slate-900 border-[#9cc8ff]';
            if (isLeadClass) return 'bg-[#dce8d5] text-slate-900 border-[#a6b99b]';
            if (isChineseTuition) return 'bg-[#fde2c6] text-slate-900 border-[#f3c79f]';
            if (isEnglishTuition) return 'bg-[#fff6bf] text-slate-900 border-[#f2e28c]';
            if (isRevisionTime) return 'bg-violet-50 text-violet-900 border-violet-200';
            if (isCCA) return 'bg-[#d7e3f3] text-slate-900 border-[#9fb7d6]';
            if (isSkating) return 'bg-[#bdefea] text-slate-900 border-[#5ec9c0]';
            if (isSpelling) return 'bg-[#4B0082] text-white border-[#2E004D]';
            if (isExam) return 'bg-[#4B0082] text-white border-[#2E004D]';
            if (isBirthday) return 'bg-pink-50 text-pink-700 border-pink-400';
            if (isNoClimbing) return 'bg-slate-200 text-slate-800 border-slate-400';
            if (isClimbing) return 'bg-[#dff7e9] text-slate-900 border-[#7dd9b0]';
            if (isSchool) return 'bg-orange-50 text-orange-700 border-orange-400';
            return 'bg-indigo-50 text-slate-600 border-indigo-400';
          }

          const maxChips = (viewMode === 'week') ? 10 : 6;
          const toShow = sortedItems.slice(0, maxChips);

          const stack = document.createElement('div');
          stack.className = 'flex flex-col gap-1';

          toShow.forEach((item) => {
            const chip = document.createElement('div');
            chip.className = `${chipBase} ${chipClassForLine(item.text)} whitespace-normal break-words`;
            chip.style.wordBreak = 'break-word';
            const em = emojiForLine(item.text);
            const shown = formatTimes12h(item.text);
            chip.textContent = em ? `${em} ${shown}` : shown;
            stack.appendChild(chip);
          });

          if (sortedItems.length > maxChips) {
            const more = document.createElement('div');
            more.className = 'text-[10px] text-slate-400';
            more.textContent = `+${sortedItems.length - maxChips} more`;
            stack.appendChild(more);
          }

          cell.appendChild(stack);
        }
      }

      if (!isFaded) cell.onclick = () => openModal(dateKey);
      calendarGrid.appendChild(cell);
    }

    function renderItemRows() {
      if (!eventItems) return;
      eventItems.innerHTML = '';
      const rows = Array.isArray(editingItems) ? editingItems : [];

      rows.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'rounded-lg border border-slate-200 bg-slate-50 p-2 space-y-2';

        const top = document.createElement('div');
        top.className = 'flex items-center gap-2';

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Item text';
        input.value = item.text || '';
        input.disabled = !canEdit;
        input.className = 'flex-1 rounded-md border border-slate-300 px-2 py-1.5 text-sm text-slate-800 focus:ring-2 focus:ring-indigo-500 transition-shadow';
        input.oninput = (e) => {
          editingItems[idx].text = e.target.value;
        };

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'Remove';
        removeBtn.disabled = !canEdit;
        removeBtn.className = 'px-2 py-1 text-xs font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-md transition-colors disabled:opacity-50';
        removeBtn.onclick = () => {
          editingItems.splice(idx, 1);
          renderItemRows();
        };

        top.appendChild(input);
        top.appendChild(removeBtn);
        row.appendChild(top);

        const checks = document.createElement('div');
        checks.className = 'flex flex-wrap gap-2';
        const selected = new Set(normalizeUsers(item.users));

        USERS.forEach((u) => {
          const label = document.createElement('label');
          label.className = 'inline-flex items-center gap-2 px-2 py-1 rounded-md bg-white border border-slate-200 text-xs text-slate-700';

          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = selected.has(u.id);
          cb.disabled = !canEdit;
          cb.onchange = () => {
            const next = new Set(normalizeUsers(editingItems[idx].users));
            if (cb.checked) next.add(u.id);
            else next.delete(u.id);
            editingItems[idx].users = [...next];
          };

          const span = document.createElement('span');
          span.textContent = u.label;

          label.appendChild(cb);
          label.appendChild(span);
          checks.appendChild(label);
        });

        row.appendChild(checks);
        eventItems.appendChild(row);
      });
    }

    function openModal(dateKey) {
      eventDateKey.value = dateKey;
      const ev = events[dateKey] || { items: [] };
      if (Array.isArray(ev.items) && ev.items.length > 0) {
        editingItems = ev.items.map((item) => ({ text: item.text || '', users: normalizeUsers(item.users) }));
      } else {
        editingItems = [{ text: '', users: getDefaultUsersForNewItem() }];
      }
      renderItemRows();
      document.getElementById('modal-title').innerText = `Events for ${dateKey}`;
      eventModal.classList.remove('hidden');
      updateEditUi();
      const firstInput = eventItems.querySelector('input[type="text"]');
      if (firstInput) firstInput.focus();
    }

    function closeModal() {
      eventModal.classList.add('hidden');
      editingItems = [];
    }

// Wire UI
    document.getElementById('prev').onclick = () => {
      if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() - 1);
      } else {
        currentDate.setDate(currentDate.getDate() - 7);
      }
      saveUiState();
      renderCalendar();
    };
    document.getElementById('next').onclick = () => {
      if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() + 1);
      } else {
        currentDate.setDate(currentDate.getDate() + 7);
      }
      saveUiState();
      renderCalendar();
    };
    document.getElementById('today-btn').onclick = () => {
      currentDate = new Date();
      saveUiState();
      renderCalendar();
    };
    jumpBtn.onclick = jumpTo;

    if (jumpMonth) {
      jumpMonth.onchange = () => {
        const v = (jumpMonth.value || '').trim(); // YYYY-MM
        if (!v) return;
        const mm = v.match(/^(\d{4})-(\d{2})$/);
        if (!mm) return;
        const d = new Date(Number(mm[1]), Number(mm[2]) - 1, 1);
        if (Number.isNaN(d.getTime())) return;
        currentDate = d;
        saveUiState();
        renderCalendar();
        // Hide again after choosing
        jumpMonth.classList.add('hidden');
      };

      // If user taps away, hide it
      jumpMonth.onblur = () => {
        // small delay so onchange can fire first
        setTimeout(() => jumpMonth.classList.add('hidden'), 150);
      };
    }
    document.getElementById('close-modal').onclick = closeModal;
    unlockBtn.onclick = unlockEditing;

    function setView(mode) {
      viewMode = mode;
      const monthActive = mode === 'month';
      viewMonthBtn.className = monthActive ? 'px-3 py-1.5 text-sm font-medium rounded-md bg-white text-slate-700 shadow-sm' : 'px-3 py-1.5 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-100';
      viewWeekBtn.className = !monthActive ? 'px-3 py-1.5 text-sm font-medium rounded-md bg-white text-slate-700 shadow-sm' : 'px-3 py-1.5 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-100';
      saveUiState();
      renderCalendar();
    }

    viewMonthBtn.onclick = () => setView('month');
    viewWeekBtn.onclick = () => setView('week');
    addItemRowBtn.onclick = () => {
      editingItems.push({ text: '', users: getDefaultUsersForNewItem() });
      renderItemRows();
      const inputs = eventItems.querySelectorAll('input[type="text"]');
      const last = inputs[inputs.length - 1];
      if (last) last.focus();
    };

    saveBtn.onclick = saveEvent;
    clearBtn.onclick = deleteDayEvent;

    // Start
    lucide.createIcons();
    updateEditUi();

    // Apply initial view mode (e.g. mobile defaults to week)
    setView(viewMode);

    // Wire calendar filter dropdown
    calendarSelect.value = currentUserFilter;
    calendarSelect.onchange = () => {
      currentUserFilter = calendarSelect.value;
      saveUiState();
      renderCalendar();
    };

    initAuth();
    renderCalendar();
  </script>
</body>
</html>
